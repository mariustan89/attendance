let isClockedIn = false;
let attendanceData = JSON.parse(localStorage.getItem("attendanceData")) || {};
let currentQRCode = null;
let isProcessing = false;  // This flag will prevent re-triggering the clocking function

function startScanner() {
    qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 300, height: 300 } },
        (decodedText) => {
            // If we are already processing (clocking in/out), don't do anything
            if (isProcessing) return;

            document.getElementById("result").innerText = decodedText;
            handleClocking(decodedText);
        },
        (error) => {
            console.log(error);
        }
    );
}

function stopScanner() {
    qrScanner.stop().then(() => {
        console.log("Scanner stopped");
    }).catch((error) => {
        console.log("Error stopping scanner: ", error);
    });
}

function handleClocking(qrData) {
    // Set the flag to indicate processing
    isProcessing = true;

    currentQRCode = qrData; // Store the scanned QR data
    const currentTime = new Date(); // Get the current time

    if (isClockedIn) {
        // Clock-out logic
        clockOut();
    } else {
        // Clock-in logic
        if (!attendanceData[qrData]) {
            attendanceData[qrData] = { clockIn: "", clockOut: "" };
        }
        attendanceData[qrData].clockIn = currentTime.toISOString(); // Save clock-in time
        document.getElementById("status").innerText = "Status: Clocked In";

        isClockedIn = true;
        document.getElementById("clockOutBtn").style.display = "inline"; // Show clock-out button
    }

    // Save updated attendance data
    localStorage.setItem("attendanceData", JSON.stringify(attendanceData));

    // Temporarily stop the scanner to avoid re-triggering the action
    stopScanner();

    // Re-enable the scanner after a short delay (1 second)
    setTimeout(() => {
        startScanner(); // Restart the scanner
    }, 1000);

    // Reset the flag after the process is done
    isProcessing = false;
}

function clockOut() {
    const currentTime = new Date(); // Get the current time
    attendanceData[currentQRCode].clockOut = currentTime.toISOString(); // Save clock-out time

    const clockInTime = new Date(attendanceData[currentQRCode].clockIn);
    const clockOutTime = new Date(attendanceData[currentQRCode].clockOut);
    const hoursWorked = (clockOutTime - clockInTime) / 1000 / 60 / 60; // Calculate hours worked

    document.getElementById("status").innerText = `Status: Clocked Out (Worked: ${hoursWorked.toFixed(2)} hours)`;
    isClockedIn = false;
    document.getElementById("clockOutBtn").style.display = "none"; // Hide clock-out button

    localStorage.setItem("attendanceData", JSON.stringify(attendanceData));
}

function viewAttendance() {
    let data = JSON.parse(localStorage.getItem("attendanceData")) || {};
    let table = "<table><tr><th>QR Code</th><th>Clock In</th><th>Clock Out</th><th>Hours Worked</th></tr>";

    for (const qrCode in data) {
        const record = data[qrCode];
        const clockInTime = new Date(record.clockIn);
        const clockOutTime = new Date(record.clockOut);
        const hoursWorked = (clockOutTime - clockInTime) / 1000 / 60 / 60; // Calculate hours worked

        table += `<tr>
            <td>${qrCode}</td>
            <td>${clockInTime.toLocaleString()}</td>
            <td>${clockOutTime.toLocaleString()}</td>
            <td>${hoursWorked.toFixed(2)}</td>
        </tr>`;
    }

    table += "</table>";
    document.getElementById("attendanceSheet").innerHTML = table;
}

startScanner();
