<script>
    const qrScanner = new Html5Qrcode("reader");

    // Variable to track clock-in status
    let isClockedIn = false;

    // Store attendance data (using localStorage as a simple approach)
    let attendanceData = JSON.parse(localStorage.getItem("attendanceData")) || {};

    function startScanner() {
        qrScanner.start(
            { facingMode: "environment" },
            {
                fps: 10,
                qrbox: (width, height) => {
                    const qrboxSize = Math.min(width, height);
                    return {
                        width: qrboxSize * 0.7,
                        height: qrboxSize * 0.5
                    };
                }
            },
            (decodedText) => {
                document.getElementById("result").innerText = decodedText;
                handleClocking(decodedText);
                stopScanner();
                setTimeout(startScanner, 2000);
            },
            (error) => {
                console.log(error);
            }
        );
    }

    function stopScanner() {
        qrScanner.stop().then(() => {
            console.log("Scanner stopped");
        }).catch((error) => {
            console.log("Error stopping scanner: ", error);
        });
    }

    function handleClocking(qrData) {
        const currentTime = new Date().toLocaleString(); // Get the current time

        // If the worker is already clocked in, clock them out
        if (isClockedIn) {
            // Save the clock-out time and calculate the hours worked
            if (!attendanceData[qrData]) {
                attendanceData[qrData] = { clockIn: "", clockOut: "" };
            }
            attendanceData[qrData].clockOut = currentTime;

            const clockInTime = new Date(attendanceData[qrData].clockIn);
            const clockOutTime = new Date(currentTime);
            const hoursWorked = (clockOutTime - clockInTime) / 1000 / 60 / 60; // Convert milliseconds to hours

            document.getElementById("status").innerText = `Status: Clocked Out (Worked: ${hoursWorked.toFixed(2)} hours)`;
            isClockedIn = false;
        } else {
            // If the worker is not clocked in, clock them in
            if (!attendanceData[qrData]) {
                attendanceData[qrData] = { clockIn: "", clockOut: "" };
            }
            attendanceData[qrData].clockIn = currentTime;

            document.getElementById("status").innerText = "Status: Clocked In";
            isClockedIn = true;
        }

        // Save the updated attendance data in localStorage
        localStorage.setItem("attendanceData", JSON.stringify(attendanceData));
    }

    startScanner();
</script>
